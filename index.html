<!DOCTYPE html>
<html lang="en">
<head>
	<title>Shower Presentation Engine</title>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen-16x10.css">
	<style>
		/* Clear slide */
		.slide.clear {
			padding: 0;
		}
		/* Cover background image */
		.cover-bg {
			padding: 0;
			background-repeat: no-repeat;
			background-size: cover;
			background-position: 50%;
		}
		.contain-bg {
			padding: 0;
			background-repeat: no-repeat;
			background-size: contain;
			background-position: 50%;
		}
		/* Remove arrow */
		.slide::after {
			display: none;
		}
		/* Slide with narrow margins */
		.slide.narrow-margins {
			padding: 53px 80px 0;
		}

		.slide_colorful h2 {
			color: white;
		}
		.slide_theme_turquoise {
			background-color: #2db2bf;
		}
		.slide_theme_raspberry {
			background-color: #c50050;
		}
		.slide_theme_violet {
			background-color: #8939a9;
		}
		.slide_theme_green {
			background-color: #359c69;
		}
		.slide_theme_light-green {
			background-color: #7ea91c;
		}
		.slide_theme_orange {
			background-color: #E67014;
		}

		.slide h3 {
		    color: #585a5e;
    		font: 700 45px/1 PT Sans Narrow,sans-serif;
		}

		/* Code */
		.slide .no-counter-code code::before {
			display: none;
		}
		.split-code {
    		float: left;
    	}
    	.split-code:first-child {
    		width: 50%;
    		margin-right: 30px;
    	}
    	.js-string {
    		color: darkgoldenrod;
    	}
    	.js-boolean, .js-number {
    		color: darkviolet;
    	}
    	.js-comment {
    		color: #999;
    	}
    	.js-keyword {
    		color: royalblue;
    	}
    	.js-return {
    		color: hotpink;
    	}
    	.html-tag {
    		color: hotpink;
    	}
    	.html-attr {
    		color: forestgreen;
    	}
    	.html-attr-val {
    		color: darkgoldenrod;
    	}
    	.cl-grey {
			color: #999;
		}
		.cl-red {
			color: #c00;
		}

	</style>
</head>
<body class="shower list">
	<header class="caption">
		<h1>Офлайн-веб</h1>
		<p>Vladimir Rakchaev, NBCO Yandex.Money LLC</p>
	</header>
	<section class="slide cover-bg" id="conf-title">
		<style>
		#conf-title {
			background-color: #E62884;
		}
		#conf-title .ym-logo {
			margin-top: 50px;
			margin-left: 243px;
		}
		#conf-title .fmix-logo {
			margin-top: 50px;
			margin-left: 243px;
		}
		</style>
		<div class="ym-logo">
			<img src="pictures/ym-logo.svg" style="width: 315px"/>
		</div>
		<div class="fmix-logo">
			<img src="pictures/fmix-logo.svg" style="width: 537px"/>
		</div>
	</section>
	<section class="slide cover-bg" id="title">
		<style>
		#title {
			background-color: #E62884;
		}
		#title .nameplate {
			position: relative;
			background-color: #030102;
			color: #fff;
			font-family: PT Sans Narrow, sans-serif;
			margin-left: 80px;
			margin-right: 80px;
			margin-top: 135px;
			font-size: 170px;
			line-height: 1.6;
			font-weight: bold;
			text-align: center;
		}
		#title .nameplate::before {
			content: '';
			position: absolute;
			border: 25px solid transparent;
			border-left: 25px solid #E62884;
			border-top: 25px solid #E62884;
			left: 0;
			top: 0;
		}
		#title .nameplate::after {
			content: '';
			position: absolute;
			border: 25px solid transparent;
			border-right: 25px solid #E62884;
			border-bottom: 25px solid #E62884;
			right: 0;
			bottom: 0;
		}
		#title .footer {
			margin-bottom: 50px;
			width: 100%;
			padding: 0 80px;
			bottom: 0;
			position: absolute;
		}
		#title .footer__item {
			position: relative;
			background-color: #030102;
			color: #fff;
			font-size: 45px;
			line-height: 65px;
			padding: 5px 20px;
		}
		#title .footer__item::before {
			content: '';
			position: absolute;
			border: 8px solid transparent;
			border-left: 8px solid #E62884;
			border-top: 8px solid #E62884;
			left: 0;
			top: 0;
		}
		</style>
		<div class="nameplate">Офлайн-веб</div>
		<div class="footer">
			<div class="footer__item" style="float: left;">Владимир Ракчаев</div>
			<div class="footer__item" style="float: right;">Яндекс.Деньги</div>
		</div>
	</section>
	<section class="slide slide_colorful slide_theme_turquoise">
		<h2 class="shout">Офлайн еще существует!</h2>
	</section>
	<section class="slide">
		<img src="pictures/vk-1.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/vk-2.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/vk-3.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/vk-4.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/mail.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/telegram.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/twitter.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/web-1.png" class="cover logo">
	</section>
	<section class="slide">
		<img src="pictures/web-2.png" class="cover logo">
	</section>
	<section class="slide slide_colorful slide_theme_raspberry">
		<h2 class="shout">Что с этим делать?</h2>
	</section>
	<section class="slide cover-bg" style="background-image: url(pictures/w3c-html5.png)"></section>
	<section class="slide cover-bg" style="background-image: url(pictures/w3c-offline-apps.png)"></section>
	<section class="slide" style="padding-top: 15px">
		<pre class="no-counter-code" style="font-size: 37px;">
			<code><span class="js-comment">app.html</span></code>
			<code>&lt;<span class="html-tag">html</span> <span class="html-attr">manifest</span>=<span class="html-attr-val">&quot;offline.appcache&quot;</span>&gt;</code>
		</pre>
		<pre class="no-counter-code next" style="font-size: 37px;">
			<code><span class="js-comment">offline.appcache</span></code>
			<code>CACHE MANIFEST</code>
			<code>app.html</code>
			<code>app.css</code>
			<code>app.js</code>
		</pre>
	</section>
	<section class="slide cover-bg" style="background-image: url(pictures/caniuse-offline-apps.png)"></section>
	<section class="slide">
		<h2 class="shout"><a href="http://alistapart.com/article/application-cache-is-a-douchebag">Application Cache is a Douchebag</a></h2>
	</section>
	<section class="slide cover-bg" style="background-image: url(pictures/whatwg-offline-apps.png)"></section>
	<section class="slide slide_colorful slide_theme_green">
		<h2 class="shout">Service Workers</h2>
	</section>
	<section class="slide cover-bg" style="background-image: url(pictures/w3c-sw.png)"></section>
	<section class="slide" style="padding-top: 180px;">
		<blockquote>Developers using the HTML5 Application Cache have also <a href="http://alistapart.com/article/application-cache-is-a-douchebag">reported that several attributes</a> of the design contribute to unrecoverable errors. A key design principle of the service worker is that errors should always be recoverable.</blockquote>
	</section>
	<section class="slide">
		<h2>Service Worker</h2>
		<p class="next">Скрипт, выполняемый браузером в фоне отдельно от веб-страниц, умеющий перехватывать и обрабатывать сетевые запросы и управлять кэшем ответа.</p>
	</section>
	<section class="slide">
		<h2>Service Worker</h2>
		<ul>
			<li class="next">JS Worker. Не имеет прямого доступа к DOM. Но может взаимодействовать со страницами через <code>postMessage</code>-интерфейс.</li>
			<li class="next">Network proxy. Может управлять обработкой сетевых запросов ваших страниц.</li>
			<li class="next">Завершается, когда не используется, и перезапускается, когда нужен. Нет глобального стейта! Для сохранения состояния между перезапусками есть доступ к <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a> API.</li>
			<li class="next">Работает только по HTTPS.</li>
		</ul>
	</section>
	<section class="slide slide_colorful slide_theme_violet">
		<h2 class="shout">Жизненный цикл SW</h2>
	</section>
	<section class="slide">
		<h2>Установка</h2>
		<ul>
			<li class="next">Зарегистрировать SW в JS страницы.</li>
			<li class="next">Браузер начнет установку в фоне.</li>
			<li class="next">Можно закэшировать некоторые ресурсы.</li>
			<li class="next">SW установлен, только если все нужные файлы загрузились и закэшировались.</li>
			<li class="next">Иначе, этап установки фэйлится, но браузер будет пытаться еще в следующий раз.</li>
			<li class="next">Успешная установка гарантирует, что в кэше есть все необходимое.</li>
		</ul>
	</section>
	<section class="slide">
		<h2>Активация</h2>
		<ul>
			<li class="next">Отличная возможность разобраться со старым кэшем при обновлении SW.</li>
		</ul>
	</section>
	<section class="slide">
		<h2>Управление</h2>
		<ul>
			<li class="next">SW управляет всеми страницами в его скоупе.</li>
			<li class="next">Зарегистрировавшая SW страница станет под его управлением только после обновления.</li>
			<li class="next">SW может
				<ul>
					<li class="next">обрабатывать <code>fetch</code> и <code>message</code> события сетевых запросов и сообщений ваших страниц;</li>
					<li class="next">быть отключен браузером для сохранения памяти.</li>
				</ul>
			</li>
		</ul>
	</section>
	<section class="slide">
		<img src="pictures/sw-lifecycle.png" class="cover logo" style="left: 45%">
	</section>
	<section class="slide slide_colorful slide_theme_light-green">
		<h2 class="shout">В коде</h2>
	</section>
	<section class="slide slide_colorful slide_theme_orange">
		<h2 class="shout">Регистрируем</h2>
	</section>
	<section class="slide" style="padding-top: 45px">
		<pre>
			<code><span class="js-keyword">if</span> (<span class="js-string">'serviceWorker'</span> <span class="js-keyword">in</span> navigator) {</code>
			<code>  navigator.serviceWorker.register(<span class="js-string">'/sw.js'</span>).then(reg => {</code>
			<code>    <span class="js-comment">// Registration was successful</span></code>
			<code>    console.log(<span class="js-string">`ServiceWorker registration successful ` +</code>
			<code>        <span class="js-string">`with scope: ${reg.scope}`</span>);</code>
			<code>  }).catch(err => {</code>
			<code>    <span class="js-comment">// registration failed :(</span></code>
			<code>    console.log(<span class="js-string">`ServiceWorker registration failed: ${err}`</span>);</code>
			<code>  });</code>
			<code>}</code>
		</pre>
	</section>
	<section class="slide">
		<h2>Регистрируем</h2>
		<ul>
			<li class="next">Повторная регистрация&nbsp;&mdash; не страшно!</li>
			<li class="next">Не забываем про скоуп!</li>
		</ul>
	</section>
	<section class="slide slide_colorful slide_theme_turquoise">
		<h2 class="shout">Кэшируем нужное</h2>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre>
			<code><span class="js-keyword">var</span> CACHE_NAME = <span class="js-string">'my-site-cache-v1'</span>;</code>
			<code><span class="js-keyword">var</span> urlsToCache = [</code>
			<code>  <span class="js-string">'/'</span>,</code>
			<code>  <span class="js-string">'/styles/main.css'</span>,</code>
			<code>  <span class="js-string">'/script/main.js'</span></code>
			<code>];</code>
			<code>self.addEventListener(<span class="js-string">'install'</span>, event => {</code>
			<code>  event.waitUntil(</code>
			<code>    caches.open(CACHE_NAME).then(cache => {</code>
			<code>      <span class="js-return">return</span> cache.addAll(urlsToCache);</code>
			<code>    })</code>
			<code>)});</code>
		</pre>
	</section>
	<section class="slide slide_colorful slide_theme_green">
		<h2 class="shout">Перехватываем запросы</h2>
	</section>
	<section class="slide" style="padding-top: 45px">
		<pre>
			<code>self.addEventListener(<span class="js-string">'fetch'</span>, event => {</code>
			<code>  event.respondWith(</code>
			<code>    caches.match(event.request).then(response => {</code>
			<code>      if (response) {</code>
			<code>        <span class="js-return">return</span> response;</code>
			<code>      }</code>
			<code>      <span class="js-return">return</span> fetch(event.request);</code>
			<code>    })</code>
			<code>  );</code>
			<code>});</code>
		</pre>
	</section>
	<section class="slide" style="padding-top: 45px">
		<pre>
			<code>self.addEventListener(<span class="js-string">'fetch'</span>, event => {</code>
			<code>  event.respondWith(</code>
			<code>    caches.match(event.request).then(response => {</code>
			<code>      <span class="js-keyword">if</span> (response) {</code>
			<code>        <span class="js-return">return</span> response;</code>
			<code>      }</code>
			<code>      <span class="js-return">return</span> fetch(event.request)<mark>.then(...)</mark>;</code>
			<code>    })</code>
			<code>  );</code>
			<code>});</code>
		</pre>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre>
			<code><span class="js-keyword">var</span> fetchRequest = event.request.clone();</code>
			<code><span class="js-return">return</span> fetch(fetchRequest).then(response => {</code>
			<code>  <span class="js-keyword">if</span> (!response || response.status !== <span class="js-number">200</span> ||</code>
			<code>        response.type !== <span class="js-string">'basic'</span>) {</code>
			<code>    <span class="js-return">return</span> response;</code>
			<code>  }</code>
			<code>  <span class="js-keyword">var</span> responseToCache = response.clone();</code>
			<code>  caches.open(CACHE_NAME).then(cache => {</code>
			<code>    cache.put(event.request, responseToCache);</code>
			<code>  });</code>
			<code>  <span class="js-return">return</span> response;</code>
			<code>}</code>
		</pre>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre>
			<code><span class="js-keyword">var</span> fetchRequest = <mark>event.request.clone()</mark>;</code>
			<code><span class="js-return">return</span> fetch(<mark>fetchRequest</mark>).then(response => {</code>
			<code>  <span class="js-keyword">if</span> (!response || response.status !== <span class="js-number">200</span> ||</code>
			<code>        response.type !== <span class="js-string">'basic'</span>) {</code>
			<code>    <span class="js-return">return</span> response;</code>
			<code>  }</code>
			<code>  <span class="js-keyword">var</span> responseToCache = response.clone();</code>
			<code>  caches.open(CACHE_NAME).then(cache => {</code>
			<code>    cache.put(<mark>event.request</mark>, responseToCache);</code>
			<code>  });</code>
			<code>  <span class="js-return">return</span> response;</code>
			<code>}</code>
		</pre>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre>
			<code><span class="js-keyword">var</span> fetchRequest = event.request.clone();</code>
			<code><span class="js-return">return</span> fetch(fetchRequest).then(response => {</code>
			<code>  <span class="js-keyword">if</span> (!response || response.status !== <span class="js-number">200</span> ||</code>
			<code>        response.type !== <span class="js-string">'basic'</span>) {</code>
			<code>    <span class="js-return">return</span> response;</code>
			<code>  }</code>
			<code>  <span class="js-keyword">var</span> responseToCache = <mark>response.clone()</mark>;</code>
			<code>  caches.open(CACHE_NAME).then(cache => {</code>
			<code>    cache.put(event.request, <mark>responseToCache</mark>);</code>
			<code>  });</code>
			<code>  <span class="js-return">return</span> <mark>response</mark>;</code>
			<code>}</code>
		</pre>
	</section>
	<section class="slide slide_colorful slide_theme_violet">
		<h2 class="shout">Обновляем</h2>
	</section>
	<section class="slide">
		<h2>Обновляем</h2>
		<ul>
			<li class="next">Обновляем наш Service Worker JS-файл.</li>
			<li class="next">Пользователь заходит на наш сайт, браузер загружает в фоне файл, если его содержимое поменялось по сравнению с текущим.</li>
			<li class="next">Новый SW запускается и тригерится событие установки.</li>
			<li class="next">Старый SW управляет текущими страницами, новый в стадии ожидания.</li>
			<li class="next">Когда открытые страницы закрываются, старый SW грохается и управление переходит новому.</li>
			<li class="next">Новый SW тригерит событие активации.</li>
		</ul>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre>
			<code>self.addEventListener(<span class="js-string">'activate'</span>, event => {</code>
			<code>  <span class="js-keyword">var</span> cacheWhitelist = [<span class="js-string">'pages-cache-v1'</span>, <span class="js-string">'posts-cache-v1'</span>];</code>
			<code>  event.waitUntil(</code>
			<code>    caches.keys().then(cacheNames => {</code>
			<code>      <span class="js-return">return</span> Promise.all(</code>
			<code>        cacheNames.map(cacheName => {</code>
			<code>          <span class="js-keyword">if</span> (cacheWhitelist.indexOf(cacheName) === <span class="js-number">-1</span>) {</code>
			<code>            <span class="js-return">return</span> caches.delete(cacheName);</code>
			<code>          }</code>
			<code>        })</code>
			<code>  )});</code>
			<code>)});</code>
		</pre>
	</section>
	<section class="slide" style="padding-top: 25px">
		<pre class="no-counter-code">
			<code class="next"><span class="js-comment">app.js</span></code>
			<code class="next">navigator.serviceWorker.register(<span class="js-string">'/sw.js'</span>)</code>
		</pre>
		<pre class="no-counter-code">
			<code class="next"><span class="js-comment">sw.js</span></code>
			<code class="next">self.addEventListener(<span class="js-string">'install'</span>, event => {...})</code>
			<code class="next">self.addEventListener(<span class="js-string">'activate'</span>, event => {...})</code>
			<code class="next">self.addEventListener(<span class="js-string">'fetch'</span>, event => {...})</code>
		</pre>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="http://www.html5rocks.com/en/tutorials/service-worker/introduction/">Introduction to Service Worker</a></h2>
	</section>
	<section class="slide slide_colorful slide_theme_light-green">
		<h2 class="shout">Стратегии</h2>
	</section>
	<section class="slide">
		<h2>Стратегии кэширования</h2>
		<ul>
			<li class="next">При установке блокирующее</li>
			<li class="next">При установке неблокирующее</li>
			<li class="next">По сетевому запросу</li>
			<li class="next">На действия пользователя</li>
		</ul>
	</section>
	<section class="slide">
		<h2>Стратегии обработки запроса</h2>
		<ul>
			<li class="next">Только кэш</li>
			<li class="next">Только сеть (аналитика, POST)</li>
			<li class="next">Кэш, потом сеть</li>
			<li class="next">Сразу кэш, потом сеть</li>
			<li class="next">Сеть, потом кэш (обновляемые ресурсы, не привязанные к версии сайта)</li>
			<li class="next">Гонка</li>
			<li class="next">Фолбэк (/offline.html)</li>
		</ul>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://jakearchibald.com/2014/offline-cookbook/">The offline cookbook</a></h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://github.com/GoogleChrome/sw-toolbox">sw-toolbox</a></h2>
	</section>
	<section class="slide">
		<pre>
			<code>importScripts(<span class="js-string">'bower_components/sw-toolbox/sw-toolbox.js'</span>);</code>
			<code>toolbox.precache([</code>
			<code>    <span class="js-string">'/index.html'</span>, </code>
			<code>    <span class="js-string">'/site.css'</span>, </code>
			<code>    <span class="js-string">'/images/logo.png'</span>]);</code>
			<code>toolbox.router.get(<span class="js-string">'/myapp/index.html'</span>, </code>
			<code>    toolbox.networkFirst);</code>
		</pre>
	</section>
	<section class="slide slide_colorful slide_theme_raspberry">
		<h2 class="shout">Демо</h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://github.com/rakchaev/sw-frontend-mix">sw-frontend-mix</a></h2>
	</section>
	<section class="slide">
		<h2 class="shout">SW могут предоставлять контент из кэша.</h2>
	</section>
	<section class="slide">
		<h2 class="shout">Но что, если странице нужно что-то отправить на сервер?</h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://developers.google.com/web/updates/2015/12/background-sync">Background Sync</a></h2>
	</section>
	<section class="slide">
		<h2 class="shout">Отправить сообщение с сервера в любой момент?</h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://www.w3.org/TR/push-api/">Push API</a></h2>
	</section>
	<section class="slide">
		<h2 class="shout">Гео?</h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="https://www.w3.org/TR/geofencing/">Geofencing API</a></h2>
	</section>
	<section class="slide cover-bg" style="background-image: url(pictures/caniuse-sw.png)"></section>
	<section class="slide slide_colorful slide_theme_orange">
		<h2 class="shout">Присоединяйся!</h2>
	</section>
	<section class="slide">
		<h2 class="shout"><a href="http://goo.gl/hJpMR1">goo.gl/hJpMR1</a></h2>
	</section>
	<section class="slide cover-bg" id="end">
		<div class="card">
			<img src="pictures/avatar.jpg" style="width: 300px;"/>
			<div style="display: inline-block; vertical-align: top;">
				<style>
				#end h2 {
					color: #000000;
					font-size: 80px;
					margin-bottom: 75px;
				}
				#end .contact {
					font-size: 50px;
					font-weight: bold;
					line-height: 1.5;
				}
				#end a {
					font-weight: bold;
					font: 700 130px/1 PT Sans Narrow,sans-serif;
				}
				#end .card {
					padding: 50px;
				}
				</style>
				<div style="padding-left: 30px">
					<h2><span style="color:red">В</span>ладимир Ракчаев</h2>
					<div>
						<div class="contact">rakchaev@yamoney.ru</div>
						<div class="contact">@rakchaev</div>
					</div>
				</div>
			</div>
		</div>
		<div style="text-align: center;"><a href="http://goo.gl/tfd5n0">goo.gl/tfd5n0</a></div>
	</section>
	<p class="badge">
		<a href="https://github.com/shower/shower">Fork me on GitHub</a>
	</p>
	<!--
		To hide progress bar from entire presentation
		just remove “progress” element.
		-->
	<div class="progress"></div>
	<script src="node_modules/shower-core/shower.min.js"></script>
	<!-- Copyright © 2015 Yours Truly, Famous Inc. -->
	<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html>
